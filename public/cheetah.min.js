var cheetahApp=angular.module("cheetahApp",["ngRoute","leaflet-directive"]);cheetahApp.config(["$routeProvider",function(e){e.when("/",{templateUrl:"fragments/map.html",controller:"mapController"})}]),cheetahApp.service("universalFilterService",[function(){var e={minimalFilterStringLength:3,alwaysCreateNewMap:!1,setAlwaysCreateNewMap:function(e){this.alwaysCreateNewMap=e},setMinimalFilterStringLength:function(e){this.minimalFilterStringLength=e},_returnOnEmptyFilterString:function(e){if(1==this.alwaysCreateNewMap){var t={};for(key in e)t[key]=e[key];return t}return e},filter:function(e,t,o){if(null==t||void 0==t||t.length<this.minimalFilterStringLength)return this._returnOnEmptyFilterString(e);var r=new RegExp(t,"i"),n={};for(key in e){var i=e[key];if(o.hasOwnProperty("length"))for(var a=0;a<o.length;++a)r.test(i[o[a]])&&(n[key]=i);else r.test(i[o])&&(n[key]=i)}return n},createFilteredMap:function(e,t,o){var r={};if(null==o||void 0==o||o.length<3)return e;var n=new RegExp(o,"i");for(key in e){var i=e[key];n.test(i[t])&&(r[key]=i)}return r}};return e}]),cheetahApp.service("tilesService",[function(){var e={tilesArray:[{name:"OpenStreetMap",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",icon:"img/icon_tiles.png",options:{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}},{name:"OpenCycleMap",url:"http://{s}.tile.opencyclemap.org/cycle/{z}/{x}/{y}.png",icon:"img/icon_tiles.png",options:{attribution:'All maps &copy; <a href="http://www.opencyclemap.org">OpenCycleMap</a>, map data &copy; <a href="http://www.openstreetmap.org">OpenStreetMap</a> (<a href="http://www.openstreetmap.org/copyright">ODbL</a>'}},{name:"Mapbox Outdoors",url:"http://api.tiles.mapbox.com/v4/{mapid}/{z}/{x}/{y}.png?access_token={apikey}",icon:"img/icon_tiles.png",type:"xyz",options:{apikey:"pk.eyJ1IjoiYnVmYW51dm9scyIsImEiOiJLSURpX0pnIn0.2_9NrLz1U9bpwMQBhVk97Q",mapid:"bufanuvols.lia3no0m"}},{name:"Mapbox Wheat Paste",url:"http://api.tiles.mapbox.com/v4/{mapid}/{z}/{x}/{y}.png?access_token={apikey}",icon:"img/icon_tiles.png",type:"xyz",options:{apikey:"pk.eyJ1IjoiYnVmYW51dm9scyIsImEiOiJLSURpX0pnIn0.2_9NrLz1U9bpwMQBhVk97Q",mapid:"bufanuvols.lia35jfp"}}]};return e}]),cheetahApp.service("markerAdapterService",["$http",function(e){var t={_convertXYToLatLng:function(e,t){return L.Projection.Mercator.unproject(L.point(e,t))},_generateIconName:function(e,t,o){return"img/center_open_035.png"},_buildMarker:function(e){var t=this._convertXYToLatLng(e.location.x,e.location.y),o={lng:t.lng,lat:t.lat,id:e.id,name:e.name,power:e.power,load:e.load,message:"<div ng-include src=\"'fragments/powerSourceBaloon.html'\"></div>",compileMessage:!0,focus:!1,active:!1,icon:{iconUrl:this._generateIconName(e.power,e.usedPower,e.status),iconSize:[34,34],iconAnchor:[17,17],popupAnchor:[0,-17],shadowUrl:"",shadowSize:[0,0],shadowAnchor:[0,0]},polygon:e.polygon};return console.log(o),o},createMarkers:function(e){for(var t={},o=0;o<e.length;++o){var r=e[o];t[r.id]=this._buildMarker(r)}return t}};return t}]),cheetahApp.service("editableEventingService",["$log",function(e){var t={events:["editable:created","editable:enable","editable:disable","editable:editing","editable:drawing:start","editable:drawing:end","editable:drawing:cancel","editable:drawing:commit","editable:drawing:click","editable:drawing:clicked","editable:vertex:click","editable:vertex:clicked","editable:vertex:ctrlclick","editable:vertex:shiftclick","editable:vertex:altclick","editable:vertex:rawclick","editable:vertex:contextmenu","editable:vertex:deleted","editable:vertex:mousedown","editable:vertex:drag","editable:vertex:dragstart","editable:vertex:dragend","editable:middlemarker:mousedown","editable:shape:new","editable:shape:delete","editable:shape:deleted"],initEvents:function(e,t){for(var o=0;o<this.events.length;++o){var r=this;e.on(this.events[o],function(e){return function(o){t.$emit(r.events[e],o)}}(o))}}};return t}]),cheetahApp.service("restConnector",["$http",function(e){var t={location:"",companyId:"",setCompanyId:function(e){this.companyId=e},getPowerSources:function(){return e.get(this.location+"/powersource/"+this.companyId)},getAttributes:function(t){return e.get(this.location+"/attribute/"+t)},getDocuments:function(t){return e.get(this.location+"/document/"+t)},postNewLocation:function(t,o){return e.post(this.location+"/powersource/"+t+"/movelocation",o)},postNewPolygon:function(t,o){return e.post(this.location+"/powersource/"+t+"/addpolygon",o)}};return t}]),cheetahApp.directive("powerSourceInfoPanel",function(){return{restrict:"AE",templateUrl:"directives/powerSourceInfoPanel.html",scope:{ps:"=",attributes:"=",documents:"=",showPanel:"="}}}),cheetahApp.controller("mapController",["$scope","leafletEvents","leafletData","editableEventingService","$rootScope","universalFilterService","tilesService","markerAdapterService","restConnector",function(e,t,o,r,n,i,a,l,c){c.setCompanyId("5c9a8644-6de0-4257-aa0e-55f063acd94d"),e.ui={showPowerSourcesList:!1,showStandalonePanel:!1,showAuthPanel:!1,searchInputString:"",selectedPowerSourceId:0,centerMapOnSelectPowerSource:!0,toolbox:{legendButtonSrc:"img/icon_legend.png",layersButtonSrc:"img/icon_layers_active.png",pressedButton:""}},e.model={powerSources:{}},e.viewModel={selected:{powerSource:null,attributes:{},documents:{}},powerSources:[],tilesArray:a.tilesArray,tiles:null},e.filterPowerSourcesList=function(){0==e.ui.searchInputString.length?e.viewModel.powerSources=i.filter(e.model.powerSources):e.viewModel.powerSources=i.filter(e.model.powerSources,e.ui.searchInputString,["name"])},e.updatePowerSources=function(){c.getPowerSources().success(function(t){e.model.powerSources=l.createMarkers(t),e.viewModel.powerSources=e.model.powerSources,e.ui.searchInputString=""})},e.setBasemap=function(t){for(var o=0;o<e.viewModel.tilesArray.length;++o){var r=e.viewModel.tilesArray[o];r.name===t&&(e.viewModel.tiles=r)}},e.setActiveElement=function(t){return null!=e.viewModel.selected.powerSource&&(e.viewModel.selected.powerSource=null,e.viewModel.selected.attributes=[],e.viewModel.selected.documents=[],e.ui.selectedPowerSourceId==t)?void(e.ui.selectedPowerSourceId=0):(e.ui.selectedPowerSourceId=t,e.viewModel.selected.powerSource=e.model.powerSources[""+t],c.getAttributes(t).success(function(t){e.viewModel.selected.attributes=t}),void(e.ui.centerMapOnSelectPowerSource&&(e.initialCenter.lat=e.viewModel.selected.powerSource.lat,e.initialCenter.lng=e.viewModel.selected.powerSource.lng)))},e.pressToolboxButton=function(t){return e.ui.toolbox.legendButtonSrc="img/icon_legend.png",e.ui.toolbox.layersButtonSrc="img/icon_layers_active.png",e.ui.toolbox.pressedButton===t?void(e.ui.toolbox.pressedButton=""):(e.ui.toolbox.pressedButton=t,"legend"===t&&(e.ui.toolbox.legendButtonSrc="img/icon_legend_pressed.png"),void("layers"===t&&(e.ui.toolbox.layersButtonSrc="img/icon_layers_pressed.png")))},e.zoomMap=function(t){t>0&&e.map.zoomIn(),0>t&&e.map.zoomOut()},e.init=function(){e.updatePowerSources(),e.setBasemap("OpenStreetMap"),o.getMap().then(function(t){e.map=t}),e.events={markers:{enable:t.getAvailableMarkerEvents()}},e.initialCenter={lat:59.95,lng:30.3,zoom:10,autoDiscover:!0},e.defaults={zoomControl:!1}},e.init(),e.$on("leafletDirectiveMarker.popupopen",function(e,t){}),e.$on("leafletDirectiveMarker.popupclose",function(t,o){e.showAdditionalPowerSourceInfoPanel=!1}),e.$on("leafletDirectiveMarker.mouseover",function(e,t){}),e.$on("leafletDirectiveMarker.mouseout",function(e,t){}),e.$on("editable:drawing:start",function(e,t){console.log("editable:drawing:start"),console.log(t)}),e.$on("editable:drawing:end",function(e,t){console.log("editable:drawing:end"),console.log(t)}),e.startDrawPolygon=function(){e.map.editTools.startPolygon()},e.startDrawPoint=function(){e.map.editTools.startMarker()}}]),cheetahApp.controller("baloonController",["$scope","powerSourceService","modelService",function(e,t,o){{var r=o.popuppedMarkerId;o.getPowerSource(r).then(function(t){e.powerSource=t.powerSource,e.attributes=t.attributes,e.documents=t.documents})}}]);